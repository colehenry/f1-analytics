name: deploy backend

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Validate secrets are set
        run: |
          echo "Checking if secrets are configured..."
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "ERROR: RAILWAY_TOKEN is not set"
            exit 1
          fi
          if [ -z "${{ secrets.RAILWAY_SERVICE_ID }}" ]; then
            echo "ERROR: RAILWAY_SERVICE_ID is not set"
            exit 1
          fi
          if [ -z "${{ secrets.RAILWAY_ENVIRONMENT_ID }}" ]; then
            echo "ERROR: RAILWAY_ENVIRONMENT_ID is not set"
            exit 1
          fi
          if [ -z "${{ secrets.RAILWAY_PROJECT_ID }}" ]; then
            echo "ERROR: RAILWAY_PROJECT_ID is not set"
            exit 1
          fi
          echo "All secrets are set"
          echo "Service ID format check: ${{ secrets.RAILWAY_SERVICE_ID }}" | grep -E '^[a-f0-9-]{36}$' && echo "Service ID format looks valid" || echo "WARNING: Service ID format might be incorrect"

      - name: Test Railway API authentication
        run: |
          echo "Testing Railway API authentication..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"query": "query { me { id email } }"}')

          http_code=$(echo "$response" | grep HTTP_CODE | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')

          echo "HTTP Status: $http_code"
          echo "Response body: $body"

          if [ "$http_code" != "200" ]; then
            echo "ERROR: Authentication failed. Check your RAILWAY_TOKEN"
            exit 1
          fi

          if echo "$body" | grep -q "error"; then
            echo "ERROR: API returned an error. Check your RAILWAY_TOKEN"
            exit 1
          fi

          echo "Authentication successful"

      - name: Trigger Railway deployment
        run: |
          echo "Triggering deployment..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation serviceInstanceRedeploy($serviceId: String!, $environmentId: String!) { serviceInstanceRedeploy(serviceId: $serviceId, environmentId: $environmentId) }",
              "variables": {
                "serviceId": "${{ secrets.RAILWAY_SERVICE_ID }}",
                "environmentId": "${{ secrets.RAILWAY_ENVIRONMENT_ID }}"
              }
            }')

          http_code=$(echo "$response" | grep HTTP_CODE | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')

          echo "HTTP Status: $http_code"
          echo "Response body: $body"

          if [ "$http_code" != "200" ]; then
            echo "ERROR: Deployment request failed with HTTP $http_code"
            exit 1
          fi

          if echo "$body" | grep -q '"errors"'; then
            echo "ERROR: Deployment failed. Response:"
            echo "$body" | grep -o '"message":"[^"]*"' || echo "$body"
            exit 1
          fi

          echo "Deployment triggered successfully"
          echo "View deployment at: https://railway.app/project/${{ secrets.RAILWAY_PROJECT_ID }}"
