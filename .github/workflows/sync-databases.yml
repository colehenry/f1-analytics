name: sync prod db -> dev db

on:
  workflow_dispatch:

jobs:
  sync-databases:
    runs-on: ubuntu-latest

    steps:
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Dump production database
        env:
          PROD_DATABASE_URL: ${{ secrets.NEON_PROD_DATABASE_URL }}
        run: |
          echo "Dumping production database..."
          pg_dump "$PROD_DATABASE_URL" --clean --if-exists --create --no-owner --no-acl -f prod_dump.sql
          echo "Production dump complete ($(wc -l < prod_dump.sql) lines)"
          echo "First 50 lines of dump:"
          head -50 prod_dump.sql

      - name: Restore to dev database
        env:
          DEV_DATABASE_URL: ${{ secrets.NEON_DEV_DATABASE_URL }}
        run: |
          echo "Restoring data to dev database..."
          echo "This will drop existing tables and recreate them with production data"
          psql "$DEV_DATABASE_URL" -f prod_dump.sql 2>&1 | tee restore_output.log
          echo "Restore complete"
          echo "Restore output:"
          cat restore_output.log

      - name: Verify sync
        env:
          DEV_DATABASE_URL: ${{ secrets.NEON_DEV_DATABASE_URL }}
        run: |
          echo "Verifying data..."
          echo "Tables in dev database:"
          psql "$DEV_DATABASE_URL" -c "\dt"
          echo ""
          echo "Row counts:"
          psql "$DEV_DATABASE_URL" -c "SELECT 'drivers' as table_name, COUNT(*) as rows FROM drivers
                                          UNION ALL SELECT 'teams', COUNT(*) FROM teams
                                          UNION ALL SELECT 'sessions', COUNT(*) FROM sessions
                                          UNION ALL SELECT 'session_results', COUNT(*) FROM session_results;"

      - name: Summary
        run: |
          echo "Database sync complete"
          echo "Production data has been copied to dev database"
