name: Sync Production to Dev Database

on:
  # Manual trigger with a button in GitHub Actions UI
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "SYNC" to confirm you want to copy production data to dev'
        required: true
        default: ''

jobs:
  sync-databases:
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "SYNC" ]; then
            echo "‚ùå Confirmation failed. You must type 'SYNC' to proceed."
            exit 1
          fi
          echo "‚úÖ Confirmation received. Proceeding with database sync..."

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Dump production database
        env:
          PROD_DATABASE_URL: ${{ secrets.NEON_PROD_DATABASE_URL }}
        run: |
          echo "üì¶ Dumping production database..."
          pg_dump "$PROD_DATABASE_URL" --no-owner --no-acl -f prod_dump.sql
          echo "‚úÖ Production dump complete ($(wc -l < prod_dump.sql) lines)"

      - name: Clear dev database
        env:
          DEV_DATABASE_URL: ${{ secrets.NEON_DEV_DATABASE_URL }}
        run: |
          echo "üóëÔ∏è  Clearing dev database..."
          psql "$DEV_DATABASE_URL" -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
          echo "‚úÖ Dev database cleared"

      - name: Restore to dev database
        env:
          DEV_DATABASE_URL: ${{ secrets.NEON_DEV_DATABASE_URL }}
        run: |
          echo "üì• Restoring data to dev database..."
          psql "$DEV_DATABASE_URL" -f prod_dump.sql
          echo "‚úÖ Restore complete"

      - name: Verify sync
        env:
          DEV_DATABASE_URL: ${{ secrets.NEON_DEV_DATABASE_URL }}
        run: |
          echo "üîç Verifying data..."
          echo "Tables in dev database:"
          psql "$DEV_DATABASE_URL" -c "\dt"
          echo ""
          echo "Row counts:"
          psql "$DEV_DATABASE_URL" -c "SELECT 'drivers' as table_name, COUNT(*) as rows FROM drivers
                                          UNION ALL SELECT 'teams', COUNT(*) FROM teams
                                          UNION ALL SELECT 'sessions', COUNT(*) FROM sessions
                                          UNION ALL SELECT 'session_results', COUNT(*) FROM session_results;"

      - name: Summary
        run: |
          echo "‚úÖ Database sync complete!"
          echo "Production data has been copied to dev database."
          echo "You can now use your dev database for local development."
